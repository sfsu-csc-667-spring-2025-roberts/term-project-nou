<!DOCTYPE html>
<html lang="en">
  <head>
    <title>UNO</title>
    <link rel="stylesheet" href="/css/lobby.css">
    <link rel="stylesheet" href="/css/global.css">
    <link rel="stylesheet" href="/css/create-game-form.css">
  </head>
  <body>
    <%- include('header') %> 
    <h1>Hello user <%= userId %></h1>
    <h2>Welcome to the UNO lobby</h2>
    
    <div id="chatWindow" class="chat-container">
        <div id="chatHeader">
            <div id="moveableHeader">Public Chat ðŸŒŽ</div>
            <button id="toggleChat" style="margin-left: 10px; cursor: pointer;">â–¼</button>
        </div>

        <div class="messages" id="messages">
            <% if (messages && messages.length > 0) { %>
                <% messages.forEach(function(message) { %>
                    <div class="message">
                        <span class="userId">User <%= message.userId %> sent: </span>
                        <span class="content"><%= message.content %></span>
                        <span class="timestamp">
                            &nbsp;<%= new Date(message.timestamp).toLocaleTimeString() %>
                        </span>
                    </div>
                <% }); %>
            <% } %>
        </div>
        <form class="message-form" id="messageForm">
            <input type="text" id="messageInput" placeholder="Type a message...">
            <button type="submit">Send</button>
        </form>
    </div>

    <section class="game-options">
        <button id = "create-game-button" class="create-game">
           <img class="image" src="images/house.png" alt="create"> 
           <h2>Create Room</h2>
        </button>
        <div class="join-game-form">
            <form action="/games/join" method="post">
                <input type="number" name="gameId" placeholder="Enter Room ID" required>
                <input type="password" name="password" placeholder="Room Password (if any)">
                <button type="submit" class="join-game">
                    <img class="image" src="images/meeting.png" alt="join">
                    <h2>Join Room</h2>
                </button>
            </form>
        </div>
    </section>

    <a href="/auth/logout" style="color: red; text-decoration: none; font-size: 1.2rem">Logout</a>
    <%- include("../games/create-form") %>


    <script src="/socket.io/socket.io.js"></script>
    <script src="js/lobby.js"></script>
    <script src="/js/header.js"></script>
    <script>
        const socket = io();
        const messagesDiv = document.getElementById('messages');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');

        // Handle incoming messages
        socket.on('chat message', (message) => {
            const messageElement = document.createElement('div');
            messageElement.className = 'message';
            messageElement.innerHTML = `
                <span class="userId">User ${message.userId} sent: </span>
                <span class="content">${message.content}</span>
                <span class="timestamp">&nbsp;${new Date(message.timestamp).toLocaleTimeString()}</span>
            `;
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        // Handle form submission
        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message) {
                socket.emit('chat message', {
                    content: message,
                    userId: '<%= userId %>',
                    timestamp: new Date()
                });
                messageInput.value = '';
            }
        });

        // Load chat history
        socket.on('chat history', (history) => {
            messagesDiv.innerHTML = '';
            history.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = 'message';
                messageElement.innerHTML = `
                    <span class="userId">User ${message.userId} sent: </span>
                    <span class="content">${message.content}</span>
                    <span class="timestamp">&nbsp;${new Date(message.timestamp).toLocaleTimeString()}</span>
                `;
                messagesDiv.appendChild(messageElement);
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
    </script>
  </body>
</html>
